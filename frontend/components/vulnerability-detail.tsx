"use client";

import { motion } from "framer-motion";
import {
  AlertTriangle, Bug, Code2, FileText, Crosshair, Wrench, BarChart3, Clock,
} from "lucide-react";
import { Badge } from "@/components/ui/badge";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { ScrollArea } from "@/components/ui/scroll-area";
import { cn, getSeverityColor } from "@/lib/utils";

interface VulnerabilityDetailProps {
  vulnerability: any;
}

export function VulnerabilityDetail({ vulnerability: vuln }: VulnerabilityDetailProps) {
  if (!vuln) {
    return (
      <Card className="border-border/50 bg-card/50">
        <CardContent className="flex items-center justify-center py-20 text-muted-foreground">
          <div className="text-center">
            <Bug className="h-10 w-10 mx-auto mb-3 opacity-30" />
            <p className="text-sm">Select a vulnerability to view details</p>
          </div>
        </CardContent>
      </Card>
    );
  }

  return (
    <motion.div
      key={vuln.id}
      initial={{ opacity: 0, x: 20 }}
      animate={{ opacity: 1, x: 0 }}
      transition={{ duration: 0.3, ease: [0.25, 0.46, 0.45, 0.94] }}
    >
      <Card className="border-border/50 bg-card/50">
        <CardHeader className="pb-3">
          <div className="flex items-start justify-between">
            <div>
              <CardTitle className="text-lg flex items-center gap-2">
                <AlertTriangle className="h-5 w-5 text-orange-400" />
                {vuln.title}
              </CardTitle>
              <div className="flex items-center gap-3 mt-2 text-xs text-muted-foreground">
                <Badge variant={vuln.severity?.toLowerCase() as any}>{vuln.severity}</Badge>
                {vuln.cwe_id && <span className="font-mono">{vuln.cwe_id}</span>}
                <span>{vuln.file_path}:{vuln.line_start}</span>
              </div>
            </div>
            <div className="text-right">
              <div className="text-2xl font-bold text-foreground">{vuln.risk_score}</div>
              <div className="text-xs text-muted-foreground">Risk Score</div>
            </div>
          </div>
        </CardHeader>

        <CardContent>
          <Tabs defaultValue="details" className="w-full">
            <TabsList className="w-full justify-start">
              <TabsTrigger value="details">Details</TabsTrigger>
              <TabsTrigger value="code">Code</TabsTrigger>
              <TabsTrigger value="exploit">Exploit</TabsTrigger>
              <TabsTrigger value="patch">Patch</TabsTrigger>
              <TabsTrigger value="scores">Scores</TabsTrigger>
            </TabsList>

            <TabsContent value="details">
              <ScrollArea className="h-[400px]">
                <div className="space-y-4 pr-4">
                  <div>
                    <h4 className="text-sm font-semibold mb-2 flex items-center gap-2">
                      <FileText className="h-4 w-4 text-blue-400" /> Description
                    </h4>
                    <p className="text-sm text-muted-foreground leading-relaxed">{vuln.description}</p>
                  </div>
                  {vuln.vulnerability_type && (
                    <div>
                      <h4 className="text-sm font-semibold mb-1">Type</h4>
                      <p className="text-sm text-muted-foreground">{vuln.vulnerability_type}</p>
                    </div>
                  )}
                  {vuln.cvss_vector && (
                    <div>
                      <h4 className="text-sm font-semibold mb-1">CVSS Vector</h4>
                      <code className="text-xs bg-muted px-2 py-1 rounded font-mono">{vuln.cvss_vector}</code>
                    </div>
                  )}
                </div>
              </ScrollArea>
            </TabsContent>

            <TabsContent value="code">
              <ScrollArea className="h-[400px]">
                <div className="space-y-4 pr-4">
                  <div>
                    <h4 className="text-sm font-semibold mb-2 flex items-center gap-2">
                      <Code2 className="h-4 w-4 text-red-400" /> Vulnerable Code
                    </h4>
                    <pre className="rounded-md bg-muted/50 p-4 text-xs font-mono overflow-x-auto border border-red-500/20">
                      <code>{vuln.vulnerable_code || "No vulnerable code snippet available"}</code>
                    </pre>
                  </div>
                  <div className="text-xs text-muted-foreground">
                    üìç {vuln.file_path} ‚Äî Lines {vuln.line_start}-{vuln.line_end}
                  </div>
                </div>
              </ScrollArea>
            </TabsContent>

            <TabsContent value="exploit">
              <ScrollArea className="h-[400px]">
                <div className="space-y-4 pr-4">
                  {vuln.exploit && (
                    <div>
                      <h4 className="text-sm font-semibold mb-2 flex items-center gap-2">
                        <Crosshair className="h-4 w-4 text-orange-400" /> Exploitation Details
                      </h4>
                      <p className="text-sm text-muted-foreground leading-relaxed">{vuln.exploit}</p>
                    </div>
                  )}
                  {vuln.exploit_script && (
                    <div>
                      <h4 className="text-sm font-semibold mb-2">Proof of Exploit Script</h4>
                      <pre className="rounded-md bg-muted/50 p-4 text-xs font-mono overflow-x-auto border border-orange-500/20">
                        <code>{vuln.exploit_script}</code>
                      </pre>
                    </div>
                  )}
                  {!vuln.exploit && !vuln.exploit_script && (
                    <p className="text-sm text-muted-foreground py-8 text-center">
                      No exploit data available
                    </p>
                  )}
                </div>
              </ScrollArea>
            </TabsContent>

            <TabsContent value="patch">
              <ScrollArea className="h-[400px]">
                <div className="space-y-4 pr-4">
                  {vuln.patch && (
                    <div>
                      <h4 className="text-sm font-semibold mb-2 flex items-center gap-2">
                        <Wrench className="h-4 w-4 text-green-400" /> Suggested Patch
                      </h4>
                      <pre className="rounded-md bg-muted/50 p-4 text-xs font-mono overflow-x-auto border border-green-500/20">
                        <code>{vuln.patch}</code>
                      </pre>
                    </div>
                  )}
                  {vuln.patch_explanation && (
                    <div>
                      <h4 className="text-sm font-semibold mb-2">Explanation</h4>
                      <p className="text-sm text-muted-foreground leading-relaxed">{vuln.patch_explanation}</p>
                    </div>
                  )}
                  {!vuln.patch && (
                    <p className="text-sm text-muted-foreground py-8 text-center">
                      No patch available
                    </p>
                  )}
                </div>
              </ScrollArea>
            </TabsContent>

            <TabsContent value="scores">
              <div className="grid grid-cols-2 gap-4 py-4">
                {[
                  { label: "Risk Score", value: vuln.risk_score, color: "text-red-400" },
                  { label: "Confidence", value: vuln.confidence, color: "text-blue-400" },
                  { label: "Exploitability", value: vuln.exploitability, color: "text-orange-400" },
                  { label: "Impact", value: vuln.impact, color: "text-purple-400" },
                ].map((metric) => (
                  <div key={metric.label} className="rounded-lg border border-border/50 p-4 bg-muted/20">
                    <div className={cn("text-3xl font-bold", metric.color)}>
                      {metric.value || 0}
                    </div>
                    <div className="text-xs text-muted-foreground mt-1">{metric.label}</div>
                    <div className="mt-2 h-1.5 rounded-full bg-muted overflow-hidden">
                      <motion.div
                        initial={{ width: 0 }}
                        animate={{ width: `${metric.value || 0}%` }}
                        transition={{ duration: 0.8, ease: "easeOut" }}
                        className={cn("h-full rounded-full", metric.color.replace("text", "bg"))}
                      />
                    </div>
                  </div>
                ))}
              </div>
            </TabsContent>
          </Tabs>
        </CardContent>
      </Card>
    </motion.div>
  );
}
